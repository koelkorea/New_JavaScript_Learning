'use strict';

// [Promise]
//  : Promise is a JavaScript object for asynchronous operation (í”„ë¡œë¯¸ìŠ¤ : ë¹„ë™ê¸° ì‘ë™ì„ ìœ„í•œ JSì˜ ê°ì²´)
//    -> ê°’ì„ ì–»ê³  ë‚œ ë’¤(ex. ì„œë²„ get), ë‚˜ì¤‘ì— ì›í• ë•Œë§ˆë‹¤ ê·¸ ë‚´ìš©ì„ ë‹¤ì‹œ êº¼ë‚´ ì´ì–´ì„œ ì›í•˜ëŠ” ì‘ì—…ì„ ì´ì–´ê°ˆ ìˆ˜ ìˆìŒ (ex. í˜ì´ì§€ ë™ì  ìƒí˜¸ì‘ìš©) 

// -Promise ì´í•´ì— í•„ìš”í•œ í•µì‹¬ê°œë…
//  1) State (ìƒíƒœê°’ì— ëŒ€í•œ ì´í•´): pending(ì „ì†¡í•˜ê¸° ìœ„í•´ ë§¤ë‹¨ ê°’) -> fulfilled(ì „ì†¡ ì´í–‰) or rejected(ì „ì†¡ ê±°ë¶€)
//  2) Producer(ë°ì´í„° ì œê³µì = promise ê°ì²´) vs Consumer(ë°ì´í„° ì‚¬ìš©ì) ì— ëŒ€í•œ ê°œë… ì´í•´ í•„ìš”
//      -> ëŒ€ì¶© producerê°€ ë³´ë‚´ì¤„(ì‚¬ìš©í• ) ê°’ì„ ì¥ì „(ì§€ì •)í•´ì£¼ëŠ” ì—­í• ì„ ì‹œì‘ìœ¼ë¡œ, Consumerì¸¡ì€ ì›í• ë•Œ ê·¸ ë‚´ìš©ì„ ë‹¤ì‹œ êº¼ë‚´ ì´ì–´ì„œ ì›í•˜ëŠ” ì‘ì—…ì„ í•  ìˆ˜ ìˆëŠ” ì—­í• ì´ë¼ ë³´ë©´ ë¨
//          -> ì´í›„ consumerëŠ” ê³„ì† ê°’ì„ ë‹¤ì‹œ êº¼ë‚´ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•¨

// - Promise ê°ì²´ ì‘ì„± êµ¬ì¡° ë° ìˆœì„œ 

//  1. Producer(ë°ì´í„° ì œê³µì = ìƒì„±ë˜ëŠ” promise ê°ì²´)
//    : (ì¤‘ìš”) when new Promise is created, the executor runs automatically (ìƒˆë¡œìš´ í”„ë¡œë¯¸ìŠ¤ ê°ì²´ ìƒì„±ì‹œì—ëŠ”, ê·¸ ë‚´ìš©(ì½œë°±)ì´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ì–´, resolveë‚˜ reject ì½œë°±ë„ ì‘ë™í•¨)
//      -> ëª¨ë“  promise ê°ì²´ëŠ” resolve(consumerì…ì¥ì—ì„œ produceì˜ ì½œë°± ì„±ê³µì‹œ ì €ì¥ê°’), reject(consumerì…ì¥ì—ì„œ produceì˜ ì½œë°± ì‹¤íŒ¨ì‹œ ì‚¬ìš©ì—ëŸ¬) ë¼ëŠ” ì½œë°±í•¨ìˆ˜ê°€ íŒŒë¼ë¯¸í„°ë¡œ ë“¤ì–´ê°„ë‹¤


//   ex) new Promise( (resolve, reject) => { resolve(ì „ë‹¬ê°’) , reject(ì‹¤íŒ¨ë‚´ìš©) ì´ ë“¤ì–´ê°„ ì½œë°±í•¨ìˆ˜ } );

//    # resolve(ì „ë‹¬ê°’) : Producer ë‹¨ê³„ì˜ ì½œë°±í•¨ìˆ˜ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í•¼ë  ì‹œ, ì´ë¥¼ ì´í›„ consumer(í”„ë¡œë¯¸ìŠ¤ë³€ìˆ˜ëª….then(ì½œë°±ë‚´ìš©) ) ë‹¨ê³„ì˜ ì½œë°±í•¨ìˆ˜ì—ì„œ ì‚¬ìš©í•  'ì „ë‹¬ê°’'ì— í•´ë‹¹í•˜ëŠ” ê°’ì„ ì „í•´ì£¼ëŠ” ì½œë°±í•¨ìˆ˜ 
//    # reject(ì—ëŸ¬ê°’)  : ì½œë°±í•¨ìˆ˜ ì‘ë™ ì‹¤íŒ¨ì‹œ, 'ì—ëŸ¬ì‹œ ë„ìš¸ ê°’'ì— í•´ë‹¹í•˜ëŠ” ê°’ ì„ ì „í•´ì£¼ëŠ” ì½œë°±í•¨
//      -> (ì¤‘ìš”) Producer ë‹¨ê³„ì˜ ëì€ ê°’ ì „ë‹¬ì´ë‹¤ (= ì£½ì–´ë‹¤ ê¹¨ì–´ë‚˜ë„, produce ë‹¨ê³„ì—ì„œëŠ” ì „ì†¡í•  ê°’ì„ ê±´ë“œë ¤ì„œ ë­˜ í•  ìˆ˜ê°€ ì—†ë‹¤)
//                -> ë‹¤ì‹œë§í•´ ì‹¤ì§ˆì ìœ¼ë¡œ producerì˜ ì½œë°±í•¨ìˆ˜ë¥¼ ì‹¤í–‰ì‹œì¼œ ì„±ê³µ/ì‹¤íŒ¨ë¥¼ ì•Œì•„ë³´ëŠ” ì£¼ì²´ëŠ” consumerë¼ëŠ” ê²ƒ

//------------------------------------------------------------------------------------------------
// ex) í”„ë¡œë¯¸ìŠ¤ ìƒì„± (producer ì‘ì„±) ì˜ˆì‹œ
//      -> (ì¤‘ìš”) ëª…ì‹¬í•˜ì! produceì˜ ëì€ resolve, rejectë¥¼ í†µí•´ consumer ë‹¨ê³„ì—ì„œ produceì˜ ì½œë°±ì„ ì„±ê³µ/ì‹¤íŒ¨ í–ˆì„ë•Œ ì‚¬ìš©í•  ê°’ì´ ë¬´ì—‡ì¸ì§€ ì„¤ì •(ì¥ì „) í•´ ë‘ëŠ”ê²ƒê¹Œì§€..
//                (= ë‹¤ì‹œë§í•´ ì‹¤ì§ˆì ìœ¼ë¡œ producerì˜ ì½œë°±í•¨ìˆ˜ë¥¼ ì‹¤í–‰ì‹œì¼œ ì„±ê³µ/ì‹¤íŒ¨ë¥¼ ì•Œì•„ë³´ëŠ” ì£¼ì²´ëŠ” consumerë¼ëŠ” ê²ƒ)

const promise = new Promise((resolve, reject) => {

  // doing some heavy work (ë³´í†µ ë¹„ë™ê¸° ì‘ì—…ì„ í•˜ê²Œ ë˜ëŠ” í”„ë¡œë¯¸ìŠ¤ ë‚´ë¶€ì—ì„œëŠ” ë¬´ê±°ìš´ ì‘ì—…ì„ í•˜ê²Œ ë¨)
  //  -> ex) network, read files
  console.log('doing something...');

  setTimeout(() => {

    // ë§Œì•½ consumerë‹¨ê³„ì—ì„œ producerë‹¨ê³„ì˜ ì½œë°±ì„?
    resolve('ellie');                  // ì„±ê³µí•œë‹¤ë©´, ì´í›„ consumerë‹¨ê³„ì˜ í”„ë¡œë¯¸ìŠ¤ê°ì²´ëª….then(valueë³€ìˆ˜ ì‚¬ìš© ì½œë°±í•¨ìˆ˜)ì„ í†µí•œ ì½œë°±ì—ì„œ ì‚¬ìš©í•  valueê°’ = 'ellie'ë¡œ ê³ ì •ë¨
    reject(new Error('no network'));   // ì‹¤íŒ¨í•œë‹¤ë©´, ì´í›„ consumerë‹¨ê³„ì˜ í”„ë¡œë¯¸ìŠ¤ê°ì²´ëª….catch(errorë³€ìˆ˜ ì‚¬ìš© ì½œë°±í•¨ìˆ˜)ì„ í†µí•œ ì½œë°±ì—ì„œ ì‚¬ìš©í•  errorê°’ = 'no network'ë¡œ ê³ ì •ë¨

  }, 2000);
});
//------------------------------------------------------------------------------------------------

//  2. Consumers(í”„ë¡œë¯¸ìŠ¤ë³€ìˆ˜ëª….then(valueê°’ ì‚¬ìš© ì½œë°±).catch(errorê°’ ì‚¬ìš© ì½œë°±).finally(ì½œë°±í•¨ìˆ˜)
//   : ì•ì„œ producer ë‹¨ê³„ì˜ ì½œë°±í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ì—¬, ì„±ê³µì‹œ resolve ì½œë°±í•¨ìˆ˜ë¥¼ í†µí•´ ê°€ì ¸ì˜¨ valueê°’ì€ then êµ¬ë¬¸ì— 
//                                             ì‹¤íŒ¨ì‹œ reject ì½œë°±í•¨ìˆ˜ë¥¼ í†µí•´ ê°€ì ¸ì˜¨ errorê°’ì€ catch êµ¬ë¬¸ì—, ë§ˆì§€ë§‰ì— finally êµ¬ë¬¸ì„ í†µí•œ ì½œë°±í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ì—¬ promise ê°ì²´ë¡œ ë¦¬í„´í•˜ëŠ” ë‹¨ê³„

//   ex) í”„ë¡œë¯¸ìŠ¤ë³€ìˆ˜ëª….then(valueê°’ ì‚¬ìš© ì½œë°±).catch(errorê°’ ì‚¬ìš© ì½œë°±).finally(ì½œë°±í•¨ìˆ˜);
//        -> then, catch, finallyëŠ” ê¼­ ì´ ìˆœì„œ ì•ˆ ì§€ì¼œë„ ë¨.. 3ë²ˆ Promise chaining ì°¸ê³ 
//           ex1) .then().then().then().then().catch()   <-   ã…‡ã…‹
//                : 4ë²ˆì˜ then() ì¤‘ ì‹¤íŒ¨ë‚˜ë©´ ë°”ë¡œ catch()ë¡œ ê°€ëŠ” êµ¬ì¡°
//           ex2) .then().then().catch().then().catch().then().finally()  <-   ã…‡ã…‹
//                : ì²« catchëŠ” ì•ì„  2ë²ˆì˜ then() ì¤‘ í•˜ë‚˜ ì‹¤íŒ¨ë‚˜ë©´ ì‹¤í–‰, ë‘ë²ˆì§¸ catchëŠ” 3ë²ˆì§¸ then()ì—ì„œ ì‹¤íŒ¨ì‹œ ì‹¤í–‰

//    # then(valueì‚¬ìš© ì½œë°±í•¨ìˆ˜) : ì•ì„œ produce ë‹¨ê³„ì˜ ì½œë°±í•¨ìˆ˜ ì„±ê³µì‹œ, resolve() ì½œë°±í•¨ìˆ˜ë¥¼ í†µí•´ ë°›ì•„ì˜¨ valueê°’ì„ ì‚¬ìš©í•œ ì½œë°±í•¨ìˆ˜ ì‹¤í–‰ í›„ promise ê°ì²´ë¡œ ë¦¬í„´
//    # catch(errorì‹œ ë„ìš¸ ê°’)   : ì•ì„œ produce ë‹¨ê³„ì˜ ì½œë°±í•¨ìˆ˜ ì‹¤íŒ¨ì‹œ, reject() ì½œë°±í•¨ìˆ˜ë¥¼ í†µí•´ ë°›ì•„ì˜¨ errorì„ ì‚¬ìš©í•œ ì½œë°±í•¨ìˆ˜ ì‹¤í–‰ í›„ promise ê°ì²´ë¡œ ë¦¬í„´
//    # finally()               : then, catch ì–´ëŠìª½ì´ë“  ì‹¤í–‰í•˜ê³  ë‚˜ì„œ ì—¬ê¸°ìˆëŠ” ì½œë°±ì„ ì‹¤í–‰ í›„ promise ê°ì²´ë¡œ ë¦¬í„´

//------------------------------------------------------------------------------------------------
// ex) í”„ë¡œë¯¸ìŠ¤ then, catch, finally (consumer ì‘ì„±) ì˜ˆì‹œ

// ì•ì„œ ì‘ì„±í•œ produce ë‹¨ê³„ì˜ Promise ê°ì²´ì˜ ë ˆí¼ëŸ°ìŠ¤ë¥¼ ì €ì¥í•œ ë³€ìˆ˜
promise 
  .then(value => {    //  produce ë‹¨ê³„ì—ì„œ ì…ë ¥í•œ ì½œë°±ì´ ì„±ê³µì‹œ : resolveë¥¼ í†µí•´ ë°›ì•„ì˜¨ ê°’ì„ valueë¼ëŠ” ì´ë¦„ìœ¼ë¡œ íŒŒë¼ë¯¸í„°ë¡œ ë„£ëŠ” í•¨ìˆ˜ë¥¼ ì‘ë™ì‹œì¼œë¼
    console.log(value); 
  })
  .catch(error => {   //  produce ë‹¨ê³„ì—ì„œ ì…ë ¥í•œ ì½œë°±ì´ ì‹¤íŒ¨ì‹œ : rejectfmf í†µí•´ ë°›ì•„ì˜¨ ê°’ì„ errorë¼ëŠ” ì´ë¦„ìœ¼ë¡œ íŒŒë¼ë¯¸í„°ë¡œ ë„£ëŠ” í•¨ìˆ˜ë¥¼ ì‘ë™ì‹œì¼œë¼
    console.log(error);
  })
  .finally(() => {    // ì„±ê³µì´ë˜ ì‹¤íŒ¨ë˜ ìµœí›„ì—ëŠ” ê¼­ ì‹¤í–‰í• ê²ƒ
    console.log('finally');
  });

  // [ì„±ê³µì‹œ]
  // doing something...
  // ellie
  // finally

  // [ì‹¤íŒ¨ì‹œ]
  // doing something...
  // Error : no network
  // finally
//------------------------------------------------------------------------------------------------

//  3. Promise chaining (í”„ë¡œë¯¸ìŠ¤ ì—°ì‡„)
//    : 2ë²ˆì˜ consumer ë‹¨ê³„ì—ì„œ then, catch, finallyëŠ” promiseê°ì²´ë¥¼ ë¦¬í„´ -> .then().then().catch() ì´ëŸ° ì‹ìœ¼ë¡œ ì¤‘ì²©ëœ ë°©ì‹ìœ¼ë¡œ ë©”ì„œë“œë¥¼ ë¬¶ì–´ ë¶™ì´ë©´ ì—°ì‡„ì  ì‹¤í–‰ì´ ê°€ëŠ¥

//------------------------------------------------------------------------------------------------
// ex) Promise chainingì„ ìœ„í•œ ë˜ ë‹¤ë¥¸ ì˜ˆì‹œ
const fetchNumber = new Promise((resolve, reject) => {
  setTimeout(() => resolve(1), 1000);
});

fetchNumber
  .then(num => num * 2) // 2
  .then(num => num * 3) // 6
  .then(num => {
    // then()ì•ˆì—ì„œ ë‹¤ë¥¸ promise ê°ì²´ë¡œ valueë¥¼ ë°›ì•„ ë˜ ë‹¤ë¥¸ 'ë¹„ë™ê¸°' ì½”ë“œë¥¼ produceë‹¨ê³„ë¡œ ì„¸íŒ…í•˜ëŠ” ê²ƒë„ ê°€ëŠ¥í•˜ë‹¤(ì–´ì°¨í”¼ promise ê°ì²´ë¡œ ë¦¬í„´ë˜ê¸°ì— í˜¸í™˜ë¨)
    return new Promise((resolve, reject) => {
      setTimeout(() => resolve(num - 1), 1000);
    });
  })
  .then(num => console.log(num));   //  5   <- ì•ì„  then()ì˜ produceë‹¨ê³„ë¥¼ consumerë‹¨ê³„ì—ì„œ ì§ì ‘ ì‹¤í–‰í•˜ëŠ” ë¶€ë¶„
//------------------------------------------------------------------------------------------------


//  4. Error Handling
//    : ë³µìˆ˜ì˜ then()êµ¬ë¬¸ì´ chaining ë˜ì—ˆì„ ë•Œ, catchêµ¬ë¬¸ì˜ ìœ„ì¹˜ë¥¼ ì˜ ì¡ëŠ”ë‹¤ë©´, ì–´ë–¤ then()ë¬¸ì—ì„œ ì—ëŸ¬ê°€ ë‚¬ëŠ”ì§€ ì¡ì„ ìˆ˜ ìˆìŒ

//------------------------------------------------------------------------------------------------
// ex) Promise chainingì„ ìœ„í•œ ë˜ ë‹¤ë¥¸ ì˜ˆì‹œ
const getHen = () =>
  new Promise((resolve, reject) => {
    setTimeout(() => resolve('ğŸ“'), 1000);
  });
const getEgg = hen =>
  new Promise((resolve, reject) => {
    setTimeout(() => reject(new Error(`error! ${hen} => ğŸ¥š`)), 1000);
  });
const cook = egg =>
  new Promise((resolve, reject) => {
    setTimeout(() => resolve(`${egg} => ğŸ³`), 1000);
  });

// getHen() 
//   .then( hen => getEgg(hen) )
//   .then( egg => cook(egg) )
//   .then( meal => console.log(meal) )
//   .catch(console.log);

// ì•”ë¬µì ìœ¼ë¡œ then, catch êµ¬ë¬¸ì— ì¸ì ìƒëµê°€ëŠ¥
getHen() 
  .then(getEgg)
  .then(cook)
  .then(console.log)
  .catch(console.log);  // Error: error! ğŸ“ => ğŸ¥š   <- 1ë²ˆì§¸ then()ë¬¸ì—ì„œ ì—ëŸ¬ê°€ ë‚¬ìŒì„ í™•ì¸ ê°€ëŠ¥

// ë¬¸ì œê°€ ë˜ëŠ” 1ë²ˆì§¸ then() êµ¬ë¬¸ì„ ë„˜ê¸°ê¸° ìœ„í•´ì„ ?
//  -> ê·¸ ì§í›„ .catchë¬¸ì„ í†µí•´ ì˜¤ë¥˜ë¥¼ ì¡ìœ¼ë©´, ì—ëŸ¬ë¬¸ ëŒ€ì‹  ğŸŒ­ì„ ë¦¬í„´í•˜ë„ë¡ í•˜ì
getHen() 
  .then(getEgg)
  .catch(error => {
    return 'ğŸŒ­';    // ì—ëŸ¬ëŒ€ì‹  ğŸŒ­ì„ ë¦¬í„´
  })
  .then(cook)
  .then(console.log)
  .catch(console.log);  // ğŸŒ­ => ğŸ³   <- 1ë²ˆì§¸ then()ë¬¸ì—ì„œ ì—ëŸ¬ê°€ ë‚œ ë¶€ë¶„ì„ ğŸŒ­ìœ¼ë¡œ ë¦¬í„´í•˜ë„ë¡ ì¡°ì¹˜ë¥¼ ì·¨í–ˆê¸°ì— ë¬¸ì œì—†ì—ˆê³ , ë‚˜ë¨¸ì§€ then()êµ¬ë¬¸ì€ ë¬¸ì œ ì—†ê¸°ì— ë¬´ì‚¬íˆ ì˜ ì‹¤í–‰ë¨
//------------------------------------------------------------------------------------------------
